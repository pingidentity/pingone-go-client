/*
PingOne User and Configuration Management API

Testing EnvironmentApiService

*/

// Code generated by OpenAPI Generator (https://openapi-generator.tech);

package pingone_test

import (
	"os"
	"testing"

	"github.com/google/uuid"
	"github.com/pingidentity/pingone-go-client/acctest"
	"github.com/pingidentity/pingone-go-client/pingone"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"github.com/stretchr/testify/suite"
)

type EnvironmentApiServiceNoAuthzTestSuite struct {
	suite.Suite
	BadApiClient *pingone.APIClient
}

func (s *EnvironmentApiServiceNoAuthzTestSuite) SetupSuite() {
	configuration := pingone.NewConfiguration()
	configuration.AppendUserAgent("testing")
	configuration.Debug = true
	s.BadApiClient = pingone.NewAPIClient(configuration)
}

type EnvironmentApiServiceTestSuite struct {
	acctest.PingOneTestSuite

	DefaultRegionCode string
	DefaultLicenseId  uuid.UUID

	DefaultEnvironmentMaxSchemaCreate  pingone.EnvironmentCreateRequest
	DefaultEnvironmentMaxSchemaReplace pingone.EnvironmentReplaceRequest
	DefaultEnvironmentMinSchemaCreate  pingone.EnvironmentCreateRequest
	DefaultEnvironmentMinSchemaReplace pingone.EnvironmentReplaceRequest

	DefaultEnvironmentBillOfMaterialsMaxSchemaCreate pingone.EnvironmentBillOfMaterialsCreateRequest
	DefaultEnvironmentBillOfMaterialsMinSchemaCreate pingone.EnvironmentBillOfMaterialsCreateRequest
}

func (s *EnvironmentApiServiceTestSuite) SetupSuite() {
	s.PingOneTestSuite.SetupSuite()

	s.DefaultRegionCode = os.Getenv("PINGONE_ENVIRONMENT_REGION")

	var err error
	s.DefaultLicenseId, err = uuid.Parse(os.Getenv("PINGONE_LICENSE_ID"))
	if err != nil {
		s.FailNow("Failed to parse license ID as a valid UUID (PingOne resource ID)", err)
	}
}

func (s *EnvironmentApiServiceTestSuite) SetupTest() {
	s.PingOneTestSuite.SetupTest()

	s.DefaultEnvironmentBillOfMaterialsMaxSchemaCreate = pingone.EnvironmentBillOfMaterialsCreateRequest{
		Products: []pingone.EnvironmentBillOfMaterialsProduct{
			{
				Type: "PING_ONE_AUTHORIZE",
			},
			{
				Type: "PING_ONE_BASE",
			},
			{
				Type: "PING_ONE_CREDENTIALS",
			},
			{
				Type: "PING_ONE_DAVINCI",
				Tags: []pingone.EnvironmentBillOfMaterialsProductTags{
					"DAVINCI_MINIMAL",
				},
			},
			{
				Type: "PING_ONE_MFA",
			},
			{
				Type: "PING_ONE_RISK",
			},
			{
				Type: "PING_ONE_VERIFY",
			},
		},
	}

	s.DefaultEnvironmentBillOfMaterialsMinSchemaCreate = pingone.EnvironmentBillOfMaterialsCreateRequest{
		Products: []pingone.EnvironmentBillOfMaterialsProduct{
			{
				Type: "PING_ONE_BASE",
			},
		},
	}

	s.DefaultEnvironmentMaxSchemaCreate = pingone.EnvironmentCreateRequest{
		BillOfMaterials: &s.DefaultEnvironmentBillOfMaterialsMaxSchemaCreate,
		Description:     pingone.PtrString("Test environment created by the PingOne Go SDK"),
		Icon:            pingone.PtrString("https://example.com/icon.png"),
		License: pingone.ResourceRelationshipPingOne{
			Id: s.DefaultLicenseId,
		},
		Name:   acctest.RandomResourceName(),
		Region: pingone.StringAsEnvironmentRegion(&s.DefaultRegionCode),
		Type:   "SANDBOX",
	}

	s.DefaultEnvironmentMinSchemaCreate = pingone.EnvironmentCreateRequest{
		License: pingone.ResourceRelationshipPingOne{
			Id: s.DefaultLicenseId,
		},
		Name:   acctest.RandomResourceName(),
		Region: pingone.StringAsEnvironmentRegion(&s.DefaultRegionCode),
		Type:   "SANDBOX",
	}

	environmentStatus := pingone.ENVIRONMENTSTATUSVALUE_DELETE_PENDING

	s.DefaultEnvironmentMaxSchemaReplace = pingone.EnvironmentReplaceRequest{
		BillOfMaterials: &s.DefaultEnvironmentBillOfMaterialsMinSchemaCreate,
		Description:     pingone.PtrString("Test environment updated by the PingOne Go SDK"),
		Icon:            pingone.PtrString("https://example.com/icon1.png"),
		License: pingone.ResourceRelationshipPingOne{
			Id: s.DefaultLicenseId,
		},
		Name:   acctest.RandomResourceName(),
		Type:   "SANDBOX",
		Status: &environmentStatus,
	}

	s.DefaultEnvironmentMinSchemaReplace = pingone.EnvironmentReplaceRequest{
		License: pingone.ResourceRelationshipPingOne{
			Id: s.DefaultLicenseId,
		},
		Name: acctest.RandomResourceName(),
		Type: "SANDBOX",
	}
}

func (s *EnvironmentApiServiceTestSuite) TearDownTest() {
	s.PingOneTestSuite.TearDownTest()
}

func (s *EnvironmentApiServiceTestSuite) TearDownSuite() {
	s.PingOneTestSuite.TearDownSuite()
}

func (s *EnvironmentApiServiceNoAuthzTestSuite) TestEnvironmentNoAuthorization() {

	environmentID := uuid.New()

	resp, httpRes, err := s.BadApiClient.EnvironmentApi.GetEnvironmentById(s.T().Context(), environmentID).Execute()

	require.NotNil(s.T(), err)
	require.Nil(s.T(), resp)
	require.NotNil(s.T(), httpRes)
	assert.Equal(s.T(), 401, httpRes.StatusCode)
	assert.EqualError(s.T(), err, "401 Unauthorized")

	require.IsType(s.T(), &pingone.APIError{}, err)
	require.IsType(s.T(), pingone.ErrorResponseMinimal{}, err.(*pingone.APIError).Model())
	assert.Equal(s.T(), err.(*pingone.APIError).Model().(pingone.ErrorResponseMinimal).Message, "Unauthorized")
}

func (s *EnvironmentApiServiceTestSuite) TestEnvironmentNeverFound() {

	environmentID := uuid.New()

	resp, httpRes, err := s.ApiClient.EnvironmentApi.GetEnvironmentById(s.T().Context(), environmentID).Execute()
	acctest.CheckNotFound(s.T(), resp, httpRes, err)
}

func (s *EnvironmentApiServiceTestSuite) TestEnvironmentFullLifecycle() {
	s.T().Skip("skip test") // remove to run test

	// Min Schema
	environmentID := s.test_pingone_EnvironmentApiService_Create(s.T(), s.DefaultEnvironmentMinSchemaCreate)

	s.test_pingone_EnvironmentApiService_Delete(s.T(), environmentID)

	// Max Schema
	environmentID = s.test_pingone_EnvironmentApiService_Create(s.T(), s.DefaultEnvironmentMaxSchemaCreate)

	// Replace Max with Min
	s.test_pingone_EnvironmentApiService_Replace(s.T(), environmentID, s.DefaultEnvironmentMinSchemaReplace)

	// Replace Min with Max
	s.test_pingone_EnvironmentApiService_Replace(s.T(), environmentID, s.DefaultEnvironmentMaxSchemaReplace)

	// Finally Delete
	s.test_pingone_EnvironmentApiService_Delete(s.T(), environmentID)
}

func (s *EnvironmentApiServiceTestSuite) test_pingone_EnvironmentApiService_Create(t *testing.T, payload pingone.EnvironmentCreateRequest) (environmentID uuid.UUID) {
	resp, httpRes, err := s.ApiClient.EnvironmentApi.CreateEnvironment(s.T().Context()).EnvironmentCreateRequest(payload).Execute()
	acctest.CheckCreated(t, resp, &pingone.Environment{}, httpRes, err)

	require.NotNil(t, resp.Id)
	assert.NotNil(t, resp.Links)
	assert.NotNil(t, resp.CreatedAt)
	assert.NotNil(t, resp.UpdatedAt)
	// TODO: Check data

	s.test_pingone_EnvironmentApiService_Get(t, environmentID, payload)

	return resp.GetId()
}

func (s *EnvironmentApiServiceTestSuite) test_pingone_EnvironmentApiService_Get(t *testing.T, environmentID uuid.UUID, payload any) {
	resp, httpRes, err := s.ApiClient.EnvironmentApi.GetEnvironmentById(s.T().Context(), environmentID).Execute()
	acctest.CheckFound(t, resp, &pingone.Environment{}, httpRes, err)

	require.NotNil(t, resp.Id)
	assert.NotNil(t, resp.Links)
	assert.NotNil(t, resp.CreatedAt)
	assert.NotNil(t, resp.UpdatedAt)

	// TODO: Check data
	switch obj := payload.(type) {
	case pingone.EnvironmentCreateRequest:
		assert.Equal(t, resp.Description, obj.Description)
	case pingone.EnvironmentReplaceRequest:
		assert.Equal(t, resp.Description, obj.Description)
	case pingone.Environment:
		assert.Equal(t, resp.Description, obj.Description)
	default:
		assert.Fail(t, "Unknown payload type")
	}
}

func (s *EnvironmentApiServiceTestSuite) test_pingone_EnvironmentApiService_Replace(t *testing.T, environmentID uuid.UUID, payload pingone.EnvironmentReplaceRequest) {
	resp, httpRes, err := s.ApiClient.EnvironmentApi.ReplaceEnvironmentById(s.T().Context(), environmentID).EnvironmentReplaceRequest(payload).Execute()
	acctest.CheckReplaced(t, resp, &pingone.Environment{}, httpRes, err)

	require.NotNil(t, resp.Id)
	assert.NotNil(t, resp.Links)
	assert.NotNil(t, resp.CreatedAt)
	assert.NotNil(t, resp.UpdatedAt)
	// TODO: Check data

	s.test_pingone_EnvironmentApiService_Get(t, environmentID, payload)
}

func (s *EnvironmentApiServiceTestSuite) test_pingone_EnvironmentApiService_Delete(t *testing.T, environmentID uuid.UUID) {
	httpRes, err := s.ApiClient.EnvironmentApi.DeleteEnvironmentById(s.T().Context(), environmentID).Execute()
	acctest.CheckDeleted(t, httpRes, err)

	resp, httpRes, err := s.ApiClient.EnvironmentApi.GetEnvironmentById(s.T().Context(), environmentID).Execute()
	acctest.CheckNotFound(t, resp, httpRes, err)
}

// func (s *EnvironmentApiServiceTestSuite) TestEnvironmentChangeEnvironmentType() {
// }

// func (s *EnvironmentApiServiceTestSuite) TestEnvironmentChangeStatus() {
// }

type EnvironmentApiServiceModifyTestSuite struct {
	acctest.NewEnvironmentTestSuite

	DefaultEnvironmentBillOfMaterialsMaxSchemaReplace pingone.EnvironmentBillOfMaterialsReplaceRequest
	DefaultEnvironmentBillOfMaterialsMinSchemaReplace pingone.EnvironmentBillOfMaterialsReplaceRequest
}

func (s *EnvironmentApiServiceModifyTestSuite) SetupSuite() {
	s.NewEnvironmentTestSuite.SetupSuite()
}

// Set up the test with a new environment
func (s *EnvironmentApiServiceModifyTestSuite) SetupTest() {
	s.NewEnvironmentTestSuite.SetupTest()

	s.DefaultEnvironmentBillOfMaterialsMaxSchemaReplace = pingone.EnvironmentBillOfMaterialsReplaceRequest{
		Products: []pingone.EnvironmentBillOfMaterialsProduct{
			{
				Type: "PING_ONE_AUTHORIZE",
			},
			{
				Type: "PING_ONE_BASE",
			},
			{
				Type: "PING_ONE_CREDENTIALS",
			},
			{
				Type: "PING_ONE_DAVINCI",
				Tags: []pingone.EnvironmentBillOfMaterialsProductTags{
					"DAVINCI_MINIMAL",
				},
			},
			{
				Type: "PING_ONE_MFA",
			},
			{
				Type: "PING_ONE_RISK",
			},
			{
				Type: "PING_ONE_VERIFY",
			},
		},
	}

	s.DefaultEnvironmentBillOfMaterialsMinSchemaReplace = pingone.EnvironmentBillOfMaterialsReplaceRequest{
		Products: []pingone.EnvironmentBillOfMaterialsProduct{
			{
				Type: "PING_ONE_BASE",
			},
		},
	}
}

func (s *EnvironmentApiServiceModifyTestSuite) TearDownTest() {
	s.NewEnvironmentTestSuite.TearDownTest()
}

func (s *EnvironmentApiServiceModifyTestSuite) TearDownSuite() {
	s.NewEnvironmentTestSuite.TearDownSuite()
}

func (s *EnvironmentApiServiceModifyTestSuite) TestEnvironmentBillOfMaterialsFullLifecycle() {
	s.T().Skip("skip test") // remove to run test

	// Replace Max with Min
	s.test_pingone_EnvironmentBillOfMaterialsApiService_Replace(s.T(), s.TestEnvironment.Environment.GetId(), s.DefaultEnvironmentBillOfMaterialsMinSchemaReplace)

	// Replace Min with Max
	s.test_pingone_EnvironmentBillOfMaterialsApiService_Replace(s.T(), s.TestEnvironment.Environment.GetId(), s.DefaultEnvironmentBillOfMaterialsMaxSchemaReplace)

	// Replace Max with Min again
	s.test_pingone_EnvironmentBillOfMaterialsApiService_Replace(s.T(), s.TestEnvironment.Environment.GetId(), s.DefaultEnvironmentBillOfMaterialsMaxSchemaReplace)

}

func (s *EnvironmentApiServiceModifyTestSuite) test_pingone_EnvironmentBillOfMaterialsApiService_Get(t *testing.T, environmentID uuid.UUID, payload any) {
	resp, httpRes, err := s.ApiClient.EnvironmentApi.GetBillOfMaterialsByEnvironmentId(s.T().Context(), environmentID).Execute()
	acctest.CheckFound(t, resp, &pingone.EnvironmentBillOfMaterials{}, httpRes, err)

	assert.NotNil(t, resp.Links)
	assert.NotNil(t, resp.CreatedAt)
	assert.NotNil(t, resp.UpdatedAt)

	// TODO: Check data
	switch obj := payload.(type) {
	case pingone.EnvironmentBillOfMaterialsCreateRequest:
		assert.Equal(t, resp.SolutionType, obj.SolutionType)
		assert.Equal(t, resp.Products, obj.Products)
	case pingone.EnvironmentBillOfMaterialsReplaceRequest:
		assert.Equal(t, resp.Products, obj.Products)
	case pingone.EnvironmentBillOfMaterials:
		assert.Equal(t, resp.SolutionType, obj.SolutionType)
		assert.Equal(t, resp.Products, obj.Products)
	default:
		assert.Fail(t, "Unknown payload type")
	}
}

func (s *EnvironmentApiServiceModifyTestSuite) test_pingone_EnvironmentBillOfMaterialsApiService_Replace(t *testing.T, environmentID uuid.UUID, payload pingone.EnvironmentBillOfMaterialsReplaceRequest) {
	resp, httpRes, err := s.ApiClient.EnvironmentApi.ReplaceBillOfMaterialsByEnvironmentId(s.T().Context(), environmentID).EnvironmentBillOfMaterialsReplaceRequest(payload).Execute()
	acctest.CheckReplaced(t, resp, &pingone.EnvironmentBillOfMaterials{}, httpRes, err)

	assert.NotNil(t, resp.Links)
	assert.NotNil(t, resp.CreatedAt)
	assert.NotNil(t, resp.UpdatedAt)
	// TODO: Check data

	s.test_pingone_EnvironmentBillOfMaterialsApiService_Get(t, environmentID, payload)
}

func Test_pingone_EnvironmentApiService(t *testing.T) {
	suite.Run(t, &EnvironmentApiServiceNoAuthzTestSuite{})
	suite.Run(t, &EnvironmentApiServiceTestSuite{})
	suite.Run(t, &EnvironmentApiServiceModifyTestSuite{})
}
